---
title: "Neural Network"
author: "Team Algoritma"
date: "2/21/2022"
output:
  learnr::tutorial:
  fig.show : 'asis'
runtime: shiny_prerendered
---
---
title: "Neural Network"
author: "Team Algoritma"
date: "2/21/2022"
output:
  learnr::tutorial:
  fig.show : 'asis'
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr) # user interface for coding exercise
knitr::opts_chunk$set(echo = TRUE)

options(scipen = 99)

# load library
library(neuralnet)
library(tidyverse)
library(caret)
library(parsons)
library(MASS)
library(rsample)
library(mlbench)
```


## Mengenal Neural Network

Hi _Future Data Scientist_! Course ini akan membahas mengenai *Neural Network* dengan R. Neural network atau Artificial Neural Network (ANN) adalah metode machine learning yang terinspirasi dari cara kerja otak manusia, terutama pada bagian __arsitektur jaringan syaraf (neuron)__ dan __proses pembelajarannya__.

## Case Regresi

Pada latihan ini, kita akan menggunakan dataset Boston yang tersedia pada package MASS. Dataset Boston adalah kumpulan data tentang nilai perumahan di pinggiran kota Boston. 

__Business question__: prediksi nilai median rumah yang ditempati pemilik (medv) menggunakan semua variabel yang tersedia.

```{r data, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Read Data
set.seed(13)
data <- Boston
```



```{r}
head(data)
```

Deskripsi Data:
* `CRIM` - per capita crime rate by town
* `ZN` - proportion of residential land zoned for lots over 25,000 sq.ft.
* `INDUS` - proportion of non-retail business acres per town.
* `CHAS` - Charles River dummy variable (1 if tract bounds river; 0 otherwise)
* `NOX` - nitric oxides concentration (parts per 10 million)
* `RM` - average number of rooms per dwelling
* `AGE` - proportion of owner-occupied units built prior to 1940
* `DIS` - weighted distances to five Boston employment centres
* `RAD` - index of accessibility to radial highways
* `TAX` - full-value property-tax rate per $10,000
* `PTRATIO` - pupil-teacher ratio by town
* `B` - 1000(Bk - 0.63)^2 where Bk is the proportion of blacks by town
* `LSTAT` - % lower status of the population
* `MEDV` - Median value of owner-occupied homes in $1000's


### Exploratory Data Analysis

Cek Dimensi Data

```{r}
dim(data)
```

Adakah tipe data yang belum sesuai?

```{r}
# koreksi tipe data
data <- data %>% 
  mutate_if(is.character, as.factor)
head(data)
```

```{r d1, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

Apakah terdapat missing value?

```{r}
# cek missing value
anyNA(data)
```

```{r d2, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```


### Data Preprocessing

Bagi data menjadi data train dan data test dengan 80% data sebagai data train. simpan data train pada variabel `train` dan data test pada variabel `test`

```{r}
# your code here
library(rsample)

set.seed(13)

index <- initial_split(data = data, prop = 0.8)

train <- training(index)
test <- testing(index)
```

```{r d3, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

```{r letter-a, echo=FALSE}
quiz(
  question("Selain cross validation, berikut ini yang termasuk dalam data preprocessing adalah...",
           type = "learnr_checkbox", correct = "Betul",
           incorrect = "Jawaban Anda masih kurang tepat", 
           allow_retry = TRUE, random_answer_order = FALSE,
           answer("Normalization", correct = T),
           answer("Scaling", correct = TRUE),
           answer("Standardization", correct = T),
           answer('Confusion matrix'))
)
```

Gunakan `model.matrix()` untuk data abalone (variable prediktor + target) dan simpan ke dalam `abalone_m`

```{r}
train_m <- model.matrix(~., data = train) %>% 
          as.data.frame()

head(train_m)
```

```{r d4, exercise = TRUE, exercise.eval = TRUE, exercise.setup = TRUE}

```

### Build Model

Fungsi `neuralnet()` hanya menerima formula lengkap; tidak menerima formula `target ~ .`, sehingga kita harus siapkan secara manual untuk formulanya. Simpan model pada variabel `nn`.

```{r}
# Build Neural Network
nn <- neuralnet(medv ~ crim + zn + indus + chas + nox 
                + rm + age + dis + rad + tax + 
                ptratio + black + lstat, 
                data = train, hidden = c(5, 3), 
                linear.output = TRUE)
```


```{r d5, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

Jika running model terlalu lama, Anda dapat mencoba mencocokan parameter - parameter dalam fungsi neuralnet() yang digunakan untuk kasus regresi. Urutkan parameter sesuai dengan dokumentasi fungsi neuralnet[!]
```{r model_nn, echo = FALSE}

question_parsons(
  initial = c(
      "formula = formula_m,",
      "hidden = C(5, 2),",
      "hidden = 5,",
      "rep = 1,",
      "rep = 'best',",
      'err.fct = "sse",',
      'err.fct = "bce",',
      "data = abalone_m,",      
      'linear.output = T',
      'linear.output = F',
      'act.fct = "logistic",',
      'act.fct = "softmax",'
  ),
  pass_if(
    c(
      "formula = formula_m,",
      "data = abalone_m,",
      "hidden = C(5, 2),",
      "rep = 1,",
      'err.fct = "sse",',
      'act.fct = "logistic",',
      'linear.output = T'
    )
  ),
  fail_if(
    ~length(.) < 6,
    message = "Include at least six answers"
  ),
  fail_if(
    function(x){"print()" %in% x},
    message = "You should not include print() in your answer"
  ),
  fail_if(
    ~{.[1] != "formula = formula_m"},
    message = "Your solution should start with 'formula = formula_m'"
  ),
    fail_if(
    ~{.[-1] != 'linear.output = T'},
    message = "perhatikan sintax parameter jika ditambahkan pada akhir"
  ),
  problem_type = 'base'
)
```

plot model `nn`:

```{r}
# Plot the neural network
plot(nn)
```

```{r d6, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

### Predict 

Untuk prediksi kita dapat gunakan `compute()`

```{r}
# Predict on test data
pr.nn <- neuralnet::compute(nn, test[,1:13])

#inspect
head(pr.nn$net.result)
```

```{r d7, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

### Evaluation

Evaluasi model dengan metrik mean square error

```{r}
# Compute mean squared error
pr.nn_ <- pr.nn$net.result * (max(data$medv) - min(data$medv)) 
                                              + min(data$medv)
test.r <- (test$medv) * (max(data$medv) - min(data$medv)) + 
                                              min(data$medv)
MSE.nn <- sum((test.r - pr.nn_)^2) / nrow(test)
```

```{r d8, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```








## Case Klasifikasi

Pada case klasifikasi ini, kita akan menggunakan dataset __Wisconsin Breast Cancer__.  Dataset diambil dari [UCI Machine Learning Repository](https://archive.ics.uci.edu/ml/datasets/Breast+Cancer+Wisconsin+(Original)

__Business question__: Prediksi apakah kanker termasuk kategori ganas (malignant) atau jinak (benign) dari rincian biopsi.

```{r data_bc, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Read Data
set.seed(13)

data(BreastCancer)
```

```{r}
head(BreastCancer)
```

Deskripsi dan range data:
* `Id`: Sample code number (id number)
* `Cl.thickness`: Clump Thickness (1 - 10)
* `Cell.size`: Uniformity of Cell Size (1 - 10)
* `Cell.shape`: Uniformity of Cell Shape (1 - 10)
* `Marg.adhesion`: Marginal Adhesion (1 - 10)
* `Epith.c.size`: Single Epithelial Cell Size (1 - 10)
* `Bare.nuclei`: Bare Nuclei (1 - 10)
* `Bl.cromatin`: Bland Chromatin (1 - 10)
* `Normal.nucleoli`: Normal Nucleoli (1 - 10)
* `Mitoses`: Mitoses (1 - 10)
* `Class`: Class (benign/malignant)


### Exploratory Data Analysis

Cek label klasifikasi

```{r}
levels(BreastCancer$Class)
```

Cek Dimensi Data

```{r}
dim(BreastCancer)
```

Adakah tipe data yang belum sesuai?

```{r}
# koreksi tipe data
BreastCancer <- BreastCancer %>% 
  mutate_if(is.character, as.factor)
head(BreastCancer)
```

```{r d9, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

Apakah terdapat missing value?

```{r}
# cek missing value
anyNA(BreastCancer)
```

```{r d10, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

Apakah proporsi kelas target seimbang?

```{r}
# cek class imbalance
 
```

### Data Preprocessing

Take out variabel yang tidak dibutuhkan dalam model:

* `Id`: Sample code number (id number)

```{r d11, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

Bagi data menjadi data train dan data test dengan 80% data sebagai data train. simpan data train pada variabel `train` dan data test pada variabel `test`

```{r}
# your code here
library(rsample)

set.seed(13)

index <- initial_split(data = BreastCancer, prop = 0.8)

train_bc <- training(index)
test_bc <- testing(index)
```

```{r d12, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

### Build Model

Fungsi `neuralnet()` hanya menerima formula lengkap; tidak menerima formula `target ~ .`, sehingga kita harus siapkan secara manual untuk formulanya. Simpan model pada variabel `nn`.

**1. Pembuatan formula**

a. Ambil nama kolom data `BreastCancer`

```{r}
colnames(BreastCancer)
```

```{r d13, exercise = TRUE, exercise.eval = TRUE, exercise.setup = TRUE}

```

b. Menghilangkan "." pada kolom tertentu menggunakan `gsub()`. Hint: tanda titik merupakan _special character_ sehingga harus di-'escape'. 

```{r}
colnames(BreastCancer) <- gsub(pattern = '\\.', replacement = '', colnames(BreastCancer))
colnames(BreastCancer)
```

```{r d14, exercise = TRUE, exercise.eval = TRUE, exercise.setup = "abalone"}

```

c. Kemudian kita buat formula untuk dimasukkan ke dalam model

#memilih prediktor
prediktor <- BreastCancer %>% 
            select(Class) %>% 
            colnames()

#membuat formula
prediktor_m <- paste(prediktor, collapse = "+")

formula_m <- paste("Class ~", prediktor_m) %>% 
            as.formula()
formula_m

```{r}


```

```{r d15, exercise = TRUE, exercise.eval = TRUE, exercise.setup = TRUE}

```

**2. Pembuatan model menggunakan `neuralnet()`**

#Build Neural Network

nn_bc <- neuralnet(formula = formula_m, 
                data = BreastCancer, hidden = c(4, 2), 
                linear.output = FALSE)
                
```{r}

```

```{r d16, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

plot model `nn_bc`:

```{r}
# Plot the neural network
#plot(nn_bc)
```

```{r d17, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

### Predict 

Untuk prediksi kita dapat gunakan `compute()`

```{r}
# Predict on test data
#pr.nn <- neuralnet::compute(nn_bc, test_bc[,1:13])

#inspect
#head(pr.nn$net.result)
```

```{r d18, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```

### Evaluation

Evaluasi model dengan melihat confusion matrix yang terbentuk

```{r}
#cm=confusionMatrix(as.factor(ytest), pr.nn$net.result)
#print(cm) 
```

```{r d19, exercise = TRUE, exercise.eval = TRUE, exercise = TRUE}

```


## Neural Network dengan Keras

### Data Preparation
1. Load dataset

2. Convert the data to matrix

3. Cross Validation

4. Prepare training and testing set (change to an array)

5. Features scaling

### Build Neural Network

1. Build a model base using keras_model_sequential()

2. Building Architecture (define layers, neurons, and activation function)

3. Building Architecture (define cost function and optimizer)

4. Fitting model in the training set

### Predicting on the testing set

### Evaluate

Confusion Matrix (classification)

### Model Tuning

Selamat, Anda telah menyelesaikan latihan dengan topik Neural Network. Semoga latihan ini berguna dan menambah pengetahuan Anda. Sampai jumpa di lain waktu.

Team Algoritma,

3/3/2022




